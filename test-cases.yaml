tests:
  - name: 原始 YAML 配置测试
    description: 验证 GitHub Gist 示例中的 Clash YAML 是否被正确解析
    input: |
      proxies:
        - name: HY2-main
          type: hysteria2
          server: hajimi.com
          port: 443
          ports: 20000-20100
          hop-interval: 15
          up: "200 Mbps"
          down: "200 Mbps"
          password: REPLACE_HY2_PASS
          sni: hajimi.com
          obfs: salamander
          obfs-password: REPLACE_OBFS_PASS
          alpn:
            - h3
          skip-cert-verify: false
          fast-open: true

        - name: TUIC-main
          type: tuic
          server: hajimi.com
          port: 444
          uuid: REPLACE_TUIC_UUID
          password: REPLACE_TUIC_PASS
          sni: hajimi.com
          alpn:
            - h3
          reduce-rtt: true
          congestion-controller: bbr
          udp-relay-mode: native
          zero-rtt: false
          fast-open: true
          skip-cert-verify: false

        - name: VLESS-REALITY
          type: vless
          server: hajimi.com
          port: 445
          uuid: REPLACE_VLESS_UUID
          udp: true
          flow: xtls-rprx-vision
          tls: true
          servername: www.apple.com
          alpn:
            - h2
            - http/1.1
          client-fingerprint: chrome
          reality-opts:
            public-key: REPLACE_PUBLIC_KEY
            short-id: a1b2c3
          packet-encoding: xudp
          skip-cert-verify: false
    expected:
      proxyCount: 3
      proxyTags:
        - HY2-main
        - TUIC-main
        - VLESS-REALITY
      typeCount:
        hysteria2: 1
        tuic: 1
        vless: 1

  - name: 空代理列表
    description: proxies 数组为空时不应返回任何节点
    input: |
      proxies: []
    expected:
      proxyCount: 0

  - name: 混合类型与无效节点
    description: 仅返回受支持类型的节点，忽略未知类型
    input: |
      proxies:
        - name: Valid-SS
          type: ss
          server: example.com
          port: 443
          cipher: aes-128-gcm
          password: test

        - name: Invalid-Type
          type: unknown
          server: invalid.com
          port: 80
    expected:
      proxyCount: 1
      proxyTags:
        - Valid-SS
      typeCount:
        shadowsocks: 1

  - name: Base64 编码 YAML
    description: 验证 Base64 包裹的 YAML 能被正确解析
    input: |
      cHJveGllczoKICAtIG5hbWU6IEJhc2U2NC1ZQU1MLVRlc3QKICAgIHR5cGU6IHR1aWMKICAgIHNlcnZlcjogdGVzdC5jb20KICAgIHBvcnQ6IDQ1NQogICAgdXVpZDogNzJlMjQ1YzUtYzY4MS00Y2JjLTljY2QtN2IxMGJiOGYyYzUzCiAgICBwYXNzd29yZDogdGVzdC1wYXNzCiAgICBzbmk6IHRlc3QuY29tCiAgICBhbHBuOgogICAgICAtIGgzCiAgICB4dWRwOiB0cnVlCiAgICB6aXA6IHh1ZHAKICAgIHNraXAtY2VydC12ZXJpZnk6IGZhbHNlCg==
    expected:
      proxyCount: 1
      proxyTags:
        - Base64-YAML-Test
      typeCount:
        tuic: 1

golden:
  - name: Clash VLESS IR 映射
    target: clash
    description: vless:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      vless://11111111-1111-1111-1111-111111111111@v.example.com:443?type=ws&path=%2Fws&sni=example.com#VLESS-WS
    expects:
      proxyByName:
        name: VLESS-WS
        fields:
          type: vless
          server: v.example.com
          port: 443
          uuid: 11111111-1111-1111-1111-111111111111

  - name: Clash VMESS HTTP IR 映射
    target: clash
    description: vmess http 传输映射 http-opts
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1IVFRQIiwKICAiYWRkIjogInZoLmV4YW1wbGUuY29tIiwKICAicG9ydCI6IDQ0MywKICAiaWQiOiAiMzMzMzMzMzMtMzMzMy0zMzMzLTMzMzMtMzMzMzMzMzMzMzMzIiwKICAibmV0IjogImh0dHAiLAogICJ0eXBlIjogImh0dHAiLAogICJwYXRoIjogIi9hcGkiLAogICJoZWFkZXJzIjogeyJVc2VyLUFnZW50IjogWyJjdXJsLzcuNzQuMCJdfSwKICAidGxzIjogInRscyIsCiAgInNuaSI6ICJ2aC5leGFtcGxlLmNvbSIKfQ==#VMESS-HTTP
    expects:
      proxyByName:
        name: VMESS-HTTP
        fields:
          type: vmess
          server: vh.example.com
          port: 443
          http-opts.method: GET
          http-opts.path.0: /api

  - name: Clash VMESS H2 IR 映射
    target: clash
    description: vmess h2 传输映射 h2-opts
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1IMiIsCiAgImFkZCI6ICJoMi5leGFtcGxlLmNvbSIsCiAgInBvcnQiOiA0NDMsCiAgImlkIjogIjQ0NDQ0NDQtNDQ0NC00NDQ0LTQ0NDQtNDQ0NDQ0NDQ0NDQ0IiwKICAibmV0IjogImgyIiwKICAicGF0aCI6ICIvIiwKICAiaG9zdCI6ICJoMi5leGFtcGxlLmNvbSIsCiAgInRscyI6ICJ0bHMiLAogICJzbmkiOiAiaDIuZXhhbXBsZS5jb20iCn0=#VMESS-H2
    expects:
      proxyByName:
        name: VMESS-H2
        fields:
          type: vmess
          server: h2.example.com
          port: 443
          h2-opts.path: /
          h2-opts.host.0: h2.example.com

  - name: Clash VLESS gRPC IR 映射
    target: clash
    description: vless grpc 传输映射 grpc-opts
    input: |
      vless://22222222-2222-2222-2222-222222222222@grpc.example.com:443?type=grpc&serviceName=mygrpc&sni=grpc.example.com#VLESS-GRPC
    expects:
      proxyByName:
        name: VLESS-GRPC
        fields:
          type: vless
          server: grpc.example.com
          port: 443
          grpc-opts.grpc-service-name: mygrpc

  - name: Clash VLESS Reality 降级校验
    target: clash
    description: clash 不支持 reality/utls，应自动降级去除相应字段
    input: |
      vless://33333333-3333-3333-3333-333333333333@reality.example.com:443?security=reality&pbk=PUBKEY123&sid=abcd&sni=example.com&alpn=h2,h3&client-fingerprint=edge#VLESS-REALITY
    expects:
      proxyByName:
        name: VLESS-REALITY
        fields:
          type: vless
          server: reality.example.com
          port: 443
          alpn.0: h2
          alpn.1: h3
        absent:
          - reality-opts
          - client-fingerprint

  - name: Xray HY2 降级校验
    target: xray
    description: xray 不支持 hy2，生成配置不应包含该出站
    input: |
      hy2://mypassword@hy.example.com:8443?alpn=h3#HY2
    expects:
      outboundAbsentTag: HY2

  - name: Clash TROJAN IR 映射
    target: clash
    description: trojan:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      trojan://topsecret@t.example.com:443?sni=example.com#TROJAN-1
    expects:
      proxyByName:
        name: TROJAN-1
        fields:
          type: trojan
          server: t.example.com
          port: 443
          password: topsecret

  - name: Singbox VMESS IR 映射
    target: singbox
    description: vmess:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1XUyIsCiAgImFkZCI6ICJ2bS5leGFtcGxlLmNvbSIsCiAgInBvcnQiOiA0NDMsCiAgImlkIjogIjIyMjIyMjItMjIyMi0yMjIyLTIyMjItMjIyMjIyMjIyMjIyIiwKICAibmV0IjogIndzIiwKICAidHlwZSI6ICJub25lIiwKICAiaG9zdCI6ICJ2bS5leGFtcGxlLmNvbSIsCiAgInBhdGgiOiAiL3dzIiwKICAidGxzIjogInRscyIsCiAgInNuaSI6ICJ2bS5leGFtcGxlLmNvbSIKfQ==#VMESS-WS
    expects:
      outboundByTag:
        tag: VMESS-WS
        fields:
          type: vmess
          server: vm.example.com
          server_port: 443

  - name: Singbox HY2 IR 映射
    target: singbox
    description: hy2:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      hy2://mypassword@hy.example.com:8443?alpn=h3#HY2
    expects:
      outboundByTag:
        tag: HY2
        fields:
          type: hysteria2
          server: hy.example.com
          server_port: 8443
          password: mypassword

  - name: Clash SS IR 映射
    target: clash
    description: ss:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      ss://YWVzLTEyOC1nY206cGFzcw@example.com:443#SS-URL
    expects:
      proxyByName:
        name: SS-URL
        fields:
          type: ss
          server: example.com
          port: 443
          cipher: aes-128-gcm
          password: pass

  - name: Singbox SS IR 映射
    target: singbox
    description: ss:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      ss://YWVzLTEyOC1nY206cGFzcw@example.com:443#SS-URL
    expects:
      outboundByTag:
        tag: SS-URL
        fields:
          type: shadowsocks
          server: example.com
          server_port: 443
          method: aes-128-gcm
          password: pass
