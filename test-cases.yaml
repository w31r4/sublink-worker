tests:
  - name: 泛用 YAML 配置解析（HY2/TUIC/VLESS）
    description: 使用通用占位与 example 域名，验证三协议关键字段与映射是否正确
    input: |
      proxies:
        - name: HY2-main
          type: hysteria2
          server: hy.example.com
          port: 443
          ports: 20000-20100
          hop-interval: 15
          up: "200 Mbps"
          down: "200 Mbps"
          password: REPLACE_HY2_PASS
          sni: hy.example.com
          obfs: salamander
          obfs-password: REPLACE_OBFS_PASS
          alpn:
            - h3
          skip-cert-verify: false
          fast-open: true

        - name: TUIC-main
          type: tuic
          server: tuic.example.com
          port: 444
          uuid: REPLACE_TUIC_UUID
          password: REPLACE_TUIC_PASS
          sni: tuic.example.com
          alpn:
            - h3
          reduce-rtt: true
          congestion-controller: bbr
          udp-relay-mode: native
          zero-rtt: false
          fast-open: true
          skip-cert-verify: false

        - name: VLESS-REALITY
          type: vless
          server: vless.example.com
          port: 445
          uuid: REPLACE_VLESS_UUID
          udp: true
          flow: xtls-rprx-vision
          tls: true
          servername: www.apple.com
          alpn:
            - h2
            - http/1.1
          client-fingerprint: chrome
          reality-opts:
            public-key: REPLACE_PUBLIC_KEY
            short-id: a1b2c3
          packet-encoding: xudp
          skip-cert-verify: false
    expected:
      proxyCount: 3
      proxyTags:
        - HY2-main
        - TUIC-main
        - VLESS-REALITY
      typeCount:
        hysteria2: 1
        tuic: 1
        vless: 1
      proxyDetails:
        - tag: HY2-main
          fields:
            type: hysteria2
            server: hy.example.com
            server_port: 443
            tls.server_name: hy.example.com
            tls.insecure: false
            alpn.0: h3
            hop_interval: 15
        - tag: TUIC-main
          fields:
            type: tuic
            server: tuic.example.com
            server_port: 444
            congestion_control: bbr
            udp_relay_mode: native
            tls.server_name: tuic.example.com
            tls.insecure: false
            tls.alpn.0: h3
            zero_rtt: false
            reduce_rtt: true
        - tag: VLESS-REALITY
          fields:
            type: vless
            server: vless.example.com
            server_port: 445
            flow: xtls-rprx-vision
            packet_encoding: xudp
            tls.reality.enabled: true
            tls.reality.public_key: REPLACE_PUBLIC_KEY
            tls.reality.short_id: a1b2c3
            tls.utls.fingerprint: chrome
            alpn.0: h2
            alpn.1: http/1.1

  - name: 空代理列表
    description: proxies 数组为空时不应返回任何节点
    input: |
      proxies: []
    expected:
      proxyCount: 0

  - name: 混合类型与无效节点
    description: 仅返回受支持类型的节点，忽略未知类型
    input: |
      proxies:
        - name: Valid-SS
          type: ss
          server: example.com
          port: 443
          cipher: aes-128-gcm
          password: test

        - name: Invalid-Type
          type: unknown
          server: invalid.com
          port: 80
    expected:
      proxyCount: 1
      proxyTags:
        - Valid-SS
      typeCount:
        shadowsocks: 1

  - name: Base64 编码 YAML
    description: 验证 Base64 包裹的 YAML 能被正确解析
    input: |
      cHJveGllczoKICAtIG5hbWU6IEJhc2U2NC1ZQU1MLVRlc3QKICAgIHR5cGU6IHR1aWMKICAgIHNlcnZlcjogdGVzdC5jb20KICAgIHBvcnQ6IDQ1NQogICAgdXVpZDogNzJlMjQ1YzUtYzY4MS00Y2JjLTljY2QtN2IxMGJiOGYyYzUzCiAgICBwYXNzd29yZDogdGVzdC1wYXNzCiAgICBzbmk6IHRlc3QuY29tCiAgICBhbHBuOgogICAgICAtIGgzCiAgICB4dWRwOiB0cnVlCiAgICB6aXA6IHh1ZHAKICAgIHNraXAtY2VydC12ZXJpZnk6IGZhbHNlCg==
    expected:
      proxyCount: 1
      proxyTags:
        - Base64-YAML-Test
      typeCount:
        tuic: 1

  - name: 泛用 YAML 配置解析（全部协议）
    description: 使用 example 域名与占位凭据，覆盖 ss/vmess/vless/trojan/hysteria2/tuic/anytls 的 YAML 解析
    input: |
      proxies:
        - name: SS-main
          type: ss
          server: ss.example.com
          port: 1443
          cipher: aes-128-gcm
          password: ss-pass

        - name: VMESS-main
          type: vmess
          server: vm.example.com
          port: 2443
          uuid: 11111111-2222-3333-4444-555555555555
          tls: true
          servername: vm.example.com
          alpn:
            - h2

        - name: VLESS-main
          type: vless
          server: vl.example.com
          port: 3443
          uuid: 66666666-7777-8888-9999-000000000000
          tls: true
          servername: vl.example.com
          alpn:
            - h2
          client-fingerprint: chrome
          reality-opts:
            public-key: PUBKEY-TEST
            short-id: abcd

        - name: TROJAN-main
          type: trojan
          server: tj.example.com
          port: 4443
          password: trojan-pass
          tls: true
          sni: tj.example.com
          alpn:
            - http/1.1

        - name: HY2-main
          type: hysteria2
          server: hy.example.com
          port: 5443
          password: hy2-pass
          sni: hy.example.com
          obfs: salamander
          obfs-password: hy2-obfs
          hop-interval: 20
          alpn:
            - h3

        - name: TUIC-main
          type: tuic
          server: tuic.example.com
          port: 6443
          uuid: 72e245c5-c681-4cbc-9ccd-7b10bb8f2c53
          password: tuic-pass
          sni: tuic.example.com
          alpn:
            - h3
          congestion-controller: bbr
          udp-relay-mode: native
          zero-rtt: false
          reduce-rtt: true
          fast-open: true
          skip-cert-verify: false

        - name: ANYTLS-main
          type: anytls
          server: at.example.com
          port: 7443
          password: anytls-pass
          udp: true
          sni: at.example.com
          alpn:
            - h2
          client-fingerprint: chrome
          skip-cert-verify: false
          idle-session-check-interval: 30
          idle-session-timeout: 120
          min-idle-session: 5
    expected:
      proxyCount: 7
      proxyTags:
        - SS-main
        - VMESS-main
        - VLESS-main
        - TROJAN-main
        - HY2-main
        - TUIC-main
        - ANYTLS-main
      typeCount:
        shadowsocks: 1
        vmess: 1
        vless: 1
        trojan: 1
        hysteria2: 1
        tuic: 1
        anytls: 1
      proxyDetails:
        - tag: SS-main
          fields:
            type: shadowsocks
            server: ss.example.com
            server_port: 1443
            method: aes-128-gcm
            password: ss-pass
        - tag: VMESS-main
          fields:
            type: vmess
            server: vm.example.com
            server_port: 2443
            uuid: 11111111-2222-3333-4444-555555555555
            tls.enabled: true
            tls.server_name: vm.example.com
            alpn.0: h2
        - tag: VLESS-main
          fields:
            type: vless
            server: vl.example.com
            server_port: 3443
            uuid: 66666666-7777-8888-9999-000000000000
            tls.enabled: true
            tls.server_name: vl.example.com
            tls.utls.fingerprint: chrome
            tls.reality.enabled: true
            tls.reality.public_key: PUBKEY-TEST
            tls.reality.short_id: abcd
            alpn.0: h2
        - tag: TROJAN-main
          fields:
            type: trojan
            server: tj.example.com
            server_port: 4443
            password: trojan-pass
            tls.server_name: tj.example.com
            alpn.0: http/1.1
        - tag: HY2-main
          fields:
            type: hysteria2
            server: hy.example.com
            server_port: 5443
            password: hy2-pass
            tls.server_name: hy.example.com
            obfs.type: salamander
            obfs.password: hy2-obfs
            hop_interval: 20
            alpn.0: h3
        - tag: TUIC-main
          fields:
            type: tuic
            server: tuic.example.com
            server_port: 6443
            uuid: 72e245c5-c681-4cbc-9ccd-7b10bb8f2c53
            password: tuic-pass
            congestion_control: bbr
            udp_relay_mode: native
            zero_rtt: false
            reduce_rtt: true
            fast_open: true
            tls.server_name: tuic.example.com
            tls.alpn.0: h3
        - tag: ANYTLS-main
          fields:
            type: anytls
            server: at.example.com
            server_port: 7443
            password: anytls-pass
            udp: true
            tls.server_name: at.example.com
            tls.insecure: false
            tls.alpn.0: h2
            tls.utls.fingerprint: chrome
            idle-session-check-interval: 30
            idle-session-timeout: 120
            min-idle-session: 5

golden:
  - name: Clash VLESS IR 映射
    target: clash
    description: vless:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      vless://11111111-1111-1111-1111-111111111111@v.example.com:443?type=ws&path=%2Fws&sni=example.com#VLESS-WS
    expects:
      proxyByName:
        name: VLESS-WS
        fields:
          type: vless
          server: v.example.com
          port: 443
          uuid: 11111111-1111-1111-1111-111111111111

  - name: Clash VMESS HTTP IR 映射
    target: clash
    description: vmess http 传输映射 http-opts
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1IVFRQIiwKICAiYWRkIjogInZoLmV4YW1wbGUuY29tIiwKICAicG9ydCI6IDQ0MywKICAiaWQiOiAiMzMzMzMzMzMtMzMzMy0zMzMzLTMzMzMtMzMzMzMzMzMzMzMzIiwKICAibmV0IjogImh0dHAiLAogICJ0eXBlIjogImh0dHAiLAogICJwYXRoIjogIi9hcGkiLAogICJoZWFkZXJzIjogeyJVc2VyLUFnZW50IjogWyJjdXJsLzcuNzQuMCJdfSwKICAidGxzIjogInRscyIsCiAgInNuaSI6ICJ2aC5leGFtcGxlLmNvbSIKfQ==#VMESS-HTTP
    expects:
      proxyByName:
        name: VMESS-HTTP
        fields:
          type: vmess
          server: vh.example.com
          port: 443
          http-opts.method: GET
          http-opts.path.0: /api

  - name: Clash VMESS H2 IR 映射
    target: clash
    description: vmess h2 传输映射 h2-opts
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1IMiIsCiAgImFkZCI6ICJoMi5leGFtcGxlLmNvbSIsCiAgInBvcnQiOiA0NDMsCiAgImlkIjogIjQ0NDQ0NDQtNDQ0NC00NDQ0LTQ0NDQtNDQ0NDQ0NDQ0NDQ0IiwKICAibmV0IjogImgyIiwKICAicGF0aCI6ICIvIiwKICAiaG9zdCI6ICJoMi5leGFtcGxlLmNvbSIsCiAgInRscyI6ICJ0bHMiLAogICJzbmkiOiAiaDIuZXhhbXBsZS5jb20iCn0=#VMESS-H2
    expects:
      proxyByName:
        name: VMESS-H2
        fields:
          type: vmess
          server: h2.example.com
          port: 443
          h2-opts.path: /
          h2-opts.host.0: h2.example.com

  - name: Clash VLESS gRPC IR 映射
    target: clash
    description: vless grpc 传输映射 grpc-opts
    input: |
      vless://22222222-2222-2222-2222-222222222222@grpc.example.com:443?type=grpc&serviceName=mygrpc&sni=grpc.example.com#VLESS-GRPC
    expects:
      proxyByName:
        name: VLESS-GRPC
        fields:
          type: vless
          server: grpc.example.com
          port: 443
          grpc-opts.grpc-service-name: mygrpc

  - name: Clash VLESS Reality 降级校验
    target: clash
    description: clash 不支持 reality/utls，应自动降级去除相应字段
    input: |
      vless://33333333-3333-3333-3333-333333333333@reality.example.com:443?security=reality&pbk=PUBKEY123&sid=abcd&sni=example.com&alpn=h2,h3&client-fingerprint=edge#VLESS-REALITY
    expects:
      proxyByName:
        name: VLESS-REALITY
        fields:
          type: vless
          server: reality.example.com
          port: 443
          alpn.0: h2
          alpn.1: h3
        absent:
          - reality-opts
          - client-fingerprint

  - name: Xray HY2 降级校验
    target: xray
    description: xray 不支持 hy2，生成配置不应包含该出站
    input: |
      hy2://mypassword@hy.example.com:8443?alpn=h3#HY2
    expects:
      outboundAbsentTag: HY2

  - name: Clash TROJAN IR 映射
    target: clash
    description: trojan:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      trojan://topsecret@t.example.com:443?sni=example.com#TROJAN-1
    expects:
      proxyByName:
        name: TROJAN-1
        fields:
          type: trojan
          server: t.example.com
          port: 443
          password: topsecret

  - name: Singbox VMESS IR 映射
    target: singbox
    description: vmess:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      vmess://ewogICJwcyI6ICJWTUVTUy1XUyIsCiAgImFkZCI6ICJ2bS5leGFtcGxlLmNvbSIsCiAgInBvcnQiOiA0NDMsCiAgImlkIjogIjIyMjIyMjItMjIyMi0yMjIyLTIyMjItMjIyMjIyMjIyMjIyIiwKICAibmV0IjogIndzIiwKICAidHlwZSI6ICJub25lIiwKICAiaG9zdCI6ICJ2bS5leGFtcGxlLmNvbSIsCiAgInBhdGgiOiAiL3dzIiwKICAidGxzIjogInRscyIsCiAgInNuaSI6ICJ2bS5leGFtcGxlLmNvbSIKfQ==#VMESS-WS
    expects:
      outboundByTag:
        tag: VMESS-WS
        fields:
          type: vmess
          server: vm.example.com
          server_port: 443

  - name: Singbox HY2 IR 映射
    target: singbox
    description: hy2:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      hy2://mypassword@hy.example.com:8443?alpn=h3#HY2
    expects:
      outboundByTag:
        tag: HY2
        fields:
          type: hysteria2
          server: hy.example.com
          server_port: 8443
          password: mypassword

  - name: Clash SS IR 映射
    target: clash
    description: ss:// URL 通过 IR 映射生成 Clash 代理项
    input: |
      ss://YWVzLTEyOC1nY206cGFzcw@example.com:443#SS-URL
    expects:
      proxyByName:
        name: SS-URL
        fields:
          type: ss
          server: example.com
          port: 443
          cipher: aes-128-gcm
          password: pass

  - name: Singbox SS IR 映射
    target: singbox
    description: ss:// URL 通过 IR 映射生成 Sing-Box outbound
    input: |
      ss://YWVzLTEyOC1nY206cGFzcw@example.com:443#SS-URL
    expects:
      outboundByTag:
        tag: SS-URL
        fields:
          type: shadowsocks
          server: example.com
          server_port: 443
          method: aes-128-gcm
          password: pass
